function computeStackContinue(n){var t=n.map(function(n,t){var e=n.date,r=e.map(function(n){var t=d3.entries(n),e=t.map(function(n){return{x:parseInt(n.key),y:n.value}});return e});return{key:n.content,lineContent:n.content,index:t,values:d3.merge(r),drag:{x:0,y:0}}});return t}function addRow(){}function deleteRow(){}function sortByCluster(n,t){return-1==t.clusterId?-1:-1==n.clusterId?1:d3.ascending(n.clusterId,t.clusterId)}function extractSelected(n,t,e){var r,u,i,o;return"intersection"!=e?(r=n.clusterId,u=n.lineContent,"sequence"==e?(i=t.filter(function(n){return n.lineContent==u&&-1!=n.clusterId}).map(function(n){return n.clusterId}),o=[u]):"cluster"==e&&(o=t.filter(function(n){return n.clusterId==r&&-1!=r}).map(function(n){return n.lineContent}),i=t.filter(function(n){return-1!=o.indexOf(n.lineContent)}).map(function(n){return n.clusterId})),i.forEach(function(n){d3.selectAll(".stack-cluster-"+n).classed("unselected",!1)})):(r=[n.source.clusterId,n.target.clusterId],i=[n.source.clusterId,n.target.clusterId],u=n.intersect,o=n.intersect),{selectedCluster:r,selectedLine:u,includeClusterArr:i,includeLineArr:o}}function computePerLineContribute(n,t,e,r){var u,i,o,a,c=0;o=e,a=e+r+1,0==e?o=e:e==n.length-1&&(a=e),u=n.slice(o,a),i=t.values.slice(o,a);for(var l=i.length,s=0;l-1>s;s++){var d;d=i[s+1].y-i[s].y;var f=i[s+1].y-i[s].y,y=u[s+1]-u[s];d=Math.abs(f),0>y*f&&(d=-d),Math.abs(y)<Math.pow(10,-20)&&(d=0),c+=d}return c/=l-1}function updateContribute(n,t){for(var e=1,r=n[0].values.map(function(n){return n.x}),u=t.totalAggre.aveAggre,i=0;i<r.length;i++){var o=r[i];n.forEach(function(n){if(n.values[i].contribution=0,-1!=n.xRange.indexOf(o)){var t=0;n.values[i].contributionPerLine=t,n.xRange.indexOf(o)!=n.xRange.length-1&&(t=computePerLineContribute(u,n,i,e),n.values[i].contributionPerLine=t),n.values[i].contribution=0==i?t:(t+n.values[i-1].contributionPerLine)/2}})}}function computeTotalAggre(n){var t=n.map(function(n){return n.values.map(function(n){return n.y})});t=d3.transpose(t);var e=t.map(function(n){return d3.sum(n)/n.length}),r=t.map(function(n){return d3.sum(n)});return{aveAggre:e,aggregation:r}}function computeClusterContribute(n){function t(n,t){return d3.ascending(n[0].x,t[0].x)}var e=[],r=d3.nest().key(function(n){return n.clusterId}).rollup(function(n){var t=n[0].xRange,e=n[0].clusterId,r=n,u={includedLineContent:r,clusterId:e,xRange:t};return u}).entries(n);return r.forEach(function(n){if(-1!=n.key){var r=n.values.xRange,u=n.values.includedLineContent,i=u.map(function(n){return n.values});i=d3.transpose(i),i=i.filter(function(n){return-1!=r.indexOf(n[0].x)}).sort(t),i.forEach(function(t){var r=t.length,u=d3.sum(t,function(n){return n.display.y}),i=d3.sum(t,function(n){return n.contribution})/r,o=d3.min(t,function(n){return n.display.y0})+u/2,a=d3.min(t,function(n){return n.display.y0})+u/10,c=t[0].x,l={clusterId:n.key,values:n.values,contribution:i,axis:{x:c,y:o},axisRect:{x:c,y:a,dy:.8*u}};e.push(l)})}}),e}function computeMaxContriLayer(n){function t(n,t){return d3.descending(Math.abs(n.contribution),Math.abs(t.contribution))}var e=n.map(function(n,t){var e=n.values.map(function(e){return{lineContent:n.lineContent,clusterId:n.clusterId,layerId:t,axis:{x:e.x,y:e.display.y/2+e.display.y0},contribution:e.contribution}});return e}),r=d3.merge(e).sort(t).slice(0,10).filter(function(n){return-1==n.clusterId});return r}function computeTotalContribute(n,t){if(0!=n.length){var e=n[0].values.map(function(n){return n.x}),r=t.totalAggre.aggregation,u=n.map(function(n){return n.values});u=d3.transpose(u);var i=u.map(function(n,t){return{x:e[t],y:r[t],contribution:d3.sum(n,function(n){return n.contribution})/n.length}});"undefined"==typeof t.totalContri&&(t.totalContri=i);var o=i.map(function(n,e){var r=Math.abs(n.contribution)-Math.abs(t.totalContri[e].contribution);return Math.abs(r)<Math.pow(10,-10)&&(r=0,n.contribution=t.totalContri[e].contribution),{x:n.x,y:n.y,dy:r,contribution:n.contribution}});return o}}function computeSankey(n,t,e){function r(n,t){return d3.ascending(n.x,t.x)}var u=n.map(function(n){var r=e.filter(function(t){return-1!=t.xRange.indexOf(n)}),u=r.map(function(t){var e=t.values.filter(function(t){return t.x==n})[0],r={clusterId:t.clusterId,lineContent:t.lineContent,key:t.key,display:{x:e.x,y:e.y,y0:e.display.y0},x:e.x,y:e.y};return r}),i=d3.nest().key(function(n){return n.clusterId}).entries(u),o=i.map(function(n){var e=d3.sum(n.values,function(n){return n.y}),r=d3.min(n.values,function(n){return n.display.y0}),u={color:"blue",dx:t,dy:e,x:n.values[0].x,y0:r,y1:r+e,name:n.values[0].clusterId,sourceLink:[],targetLink:[],lineContentArr:n.values,lineContent:n.values.map(function(n){return n.lineContent}),clusterId:n.values[0].clusterId,value:e,numLine:n.values.length};return u});return o});u=u.sort(r);for(var i=[],o=[],a=0;a<u.length-1;a++){var c=computeLinkBetweenNodes(u[a],u[a+1],t);i=i.concat(c),o=o.concat(u[a])}return o=o.concat(u[u.length-1]),{nodeArr:o,linkArr:i}}function computeLinkBetweenNodes(n,t,e){function r(n,t){return d3.ascending(n.y0,t.y0)}function u(n,t,r){var u,i,o,a,c,l,s,d,f={defined:-1},y=findIntersection(n.lineContent,t.lineContent);if(0!=y.length){var v=n.lineContentArr.filter(function(n){return-1!=y.indexOf(n.lineContent)}),x=t.lineContentArr.filter(function(n){return-1!=y.indexOf(n.lineContent)});u=d3.sum(v,function(n){return n.y}),i=d3.sum(x,function(n){return n.y}),o=r.filter(function(t){return t.clusterId==n.clusterId&&t.x==n.x})[0].y0,c=r.filter(function(n){return n.clusterId==t.clusterId&&n.x==t.x})[0].y0,a=o+u,l=c+i,s=n.x,d=t.x,r.forEach(function(e){e.clusterId==n.clusterId&&e.x==n.x?e.y0=a:e.clusterId==t.clusterId&&e.x==t.x&&(e.y0=l)}),f={defined:1,dy0:u,dy1:i,links:[{source:{x:s,y:o,nodeTrans:e/2},target:{x:d,y:c,nodeTrans:-e/2}},{source:{x:s,y:a,nodeTrans:e/2},target:{x:d,y:l,nodeTrans:-e/2}}],drag:{x:0,y:0},intersect:y,source:n,target:t}}return{clusterLink:f,nodeBaseLine:r}}t=t.sort(r),n=n.sort(r);var i=[],o=n.concat(t).map(function(n){return{clusterId:n.clusterId,y0:n.y0,x:n.x}});return n.forEach(function(n){t.forEach(function(t){var e=u(n,t,o),r=e.clusterLink;o=e.nodeBaseLine,1==r.defined&&(i.push(r),n.sourceLink.push(r),t.targetLink.push(r))})}),i}function findNail(n,t,e){if(0!=n.curDrag){{var r=t[0]-n.m_nail.left-20,u=(t[1]-20,-2),i=0,o=n.rectOffset_nail;n.height_nail+2*o.height+i}if(e){var r=t[0];t[1]}for(var a=n.nailDataArr,c=0;c<a.length;c++)r>=a[c].startPoint_nail-o.width&&r<=a[c].endPoint_nail+o.width?u=c:0==c&&r<a[c].startPoint_nail-o.width?u=-.1:c!=a.length-1&&r>a[c].endPoint_nail+o.width&&r<a[c+1].startPoint_nail-o.width?u=c+.1:c==a.length-1&&r>a[c].endPoint_nail+o.width&&(u=-1);n.toIndex=u}}var interpolate="monotone";