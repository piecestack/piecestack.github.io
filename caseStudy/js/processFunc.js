function computeStackContinue(n){var t=n.map(function(n,t){var e=n.date,r=e.map(function(n){var t=d3.entries(n),e=t.map(function(n){return{x:parseInt(n.key),y:n.value}});return e});return{key:n.content,lineContent:n.content,index:t,values:d3.merge(r),drag:{x:0,y:0}}});return t}function addRow(n,t){var e=document.getElementById("myTableData"),r=t.listContent;if(0==r.length)n.forEach(function(n){var t=e.rows.length,r=e.insertRow(t);r.insertCell(0).innerHTML='<span class = "singleTag row'+n+'">&emsp;'+shortContent[n]+"&emsp;</span>"});else if(r.length>0&&1==n.length){var i=r.filter(function(t){return t.lineContent==n[0]});if(0==i.length)return;i[0].list.forEach(function(n){var t=e.rows.length,r='<span class = "contentTag">&emsp;'+i[0].lineContent+'&emsp;</span> <span class = "contentTime">&emsp;'+n.date+'&emsp;</span> <br/><span class = "content">'+n.content+"</span>",u=e.insertRow(t);u.insertCell(0).innerHTML=r})}}function deleteRow(){for(var n=document.getElementById("myTableData"),t=n.rows.length;t>0;t--)n.deleteRow(t-1)}function sortByCluster(n,t){return-1==t.clusterId?-1:-1==n.clusterId?1:d3.ascending(n.clusterId,t.clusterId)}function extractSelected(n,t,e){var r,i,u,o;return"intersection"!=e?(r=n.clusterId,i=n.lineContent,"sequence"==e?(u=t.filter(function(n){return n.lineContent==i&&-1!=n.clusterId}).map(function(n){return n.clusterId}),o=[i]):"cluster"==e&&(o=t.filter(function(n){return n.clusterId==r&&-1!=r}).map(function(n){return n.lineContent}),u=t.filter(function(n){return-1!=o.indexOf(n.lineContent)}).map(function(n){return n.clusterId})),u.forEach(function(n){d3.selectAll(".stack-cluster-"+n).classed("unselected",!1)})):(r=[n.source.clusterId,n.target.clusterId],u=[n.source.clusterId,n.target.clusterId],i=n.intersect,o=n.intersect),{selectedCluster:r,selectedLine:i,includeClusterArr:u,includeLineArr:o}}function computePerLineContribute(n,t,e,r){var i,u,o,a,c=0;o=e,a=e+r+1,0==e?o=e:e==n.length-1&&(a=e),i=n.slice(o,a),u=t.values.slice(o,a);for(var s=u.length,l=0;s-1>l;l++){var d;d=u[l+1].y-u[l].y;var f=u[l+1].y-u[l].y,y=i[l+1]-i[l];d=Math.abs(f),0>y*f&&(d=-d),Math.abs(y)<Math.pow(10,-20)&&(d=0),c+=d}return c/=s-1}function updateContribute(n,t){for(var e=1,r=n[0].values.map(function(n){return n.x}),i=t.totalAggre.aveAggre,u=0;u<r.length;u++){var o=r[u];n.forEach(function(n){if(n.values[u].contribution=0,-1!=n.xRange.indexOf(o)){var t=0;n.values[u].contributionPerLine=t,n.xRange.indexOf(o)!=n.xRange.length-1&&(t=computePerLineContribute(i,n,u,e),n.values[u].contributionPerLine=t),n.values[u].contribution=0==u?t:(t+n.values[u-1].contributionPerLine)/2}})}}function computeTotalAggre(n){var t=n.map(function(n){return n.values.map(function(n){return n.y})});t=d3.transpose(t);var e=t.map(function(n){return d3.sum(n)/n.length}),r=t.map(function(n){return d3.sum(n)});return{aveAggre:e,aggregation:r}}function computeClusterContribute(n){function t(n,t){return d3.ascending(n[0].x,t[0].x)}var e=[],r=d3.nest().key(function(n){return n.clusterId}).rollup(function(n){var t=n[0].xRange,e=n[0].clusterId,r=n,i={includedLineContent:r,clusterId:e,xRange:t};return i}).entries(n);return r.forEach(function(n){if(-1!=n.key){var r=n.values.xRange,i=n.values.includedLineContent,u=i.map(function(n){return n.values});u=d3.transpose(u),u=u.filter(function(n){return-1!=r.indexOf(n[0].x)}).sort(t),u.forEach(function(t){var r=t.length,i=d3.sum(t,function(n){return n.display.y}),u=d3.sum(t,function(n){return n.contribution})/r,o=d3.min(t,function(n){return n.display.y0})+i/2,a=d3.min(t,function(n){return n.display.y0})+i/10,c=t[0].x,s={clusterId:n.key,values:n.values,contribution:u,axis:{x:c,y:o},axisRect:{x:c,y:a,dy:.8*i}};e.push(s)})}}),e}function computeMaxContriLayer(n){function t(n,t){return d3.descending(Math.abs(n.contribution),Math.abs(t.contribution))}var e=n.map(function(n,t){var e=n.values.map(function(e){return{lineContent:n.lineContent,clusterId:n.clusterId,layerId:t,axis:{x:e.x,y:e.display.y/2+e.display.y0},contribution:e.contribution}});return e}),r=d3.merge(e).sort(t).slice(0,10).filter(function(n){return-1==n.clusterId});return r}function computeTotalContribute(n,t){if(0!=n.length){var e=n[0].values.map(function(n){return n.x}),r=t.totalAggre.aggregation,i=n.map(function(n){return n.values});i=d3.transpose(i);var u=i.map(function(n,t){return{x:e[t],y:r[t],contribution:d3.sum(n,function(n){return n.contribution})/n.length}});"undefined"==typeof t.totalContri&&(t.totalContri=u);var o=u.map(function(n,e){var r=Math.abs(n.contribution)-Math.abs(t.totalContri[e].contribution);return Math.abs(r)<Math.pow(10,-10)&&(r=0,n.contribution=t.totalContri[e].contribution),{x:n.x,y:n.y,dy:r,contribution:n.contribution}});return o}}function computeSankey(n,t,e){function r(n,t){return d3.ascending(n.x,t.x)}var i=n.map(function(n){var r=e.filter(function(t){return-1!=t.xRange.indexOf(n)}),i=r.map(function(t){var e=t.values.filter(function(t){return t.x==n})[0],r={clusterId:t.clusterId,lineContent:t.lineContent,key:t.key,display:{x:e.x,y:e.y,y0:e.display.y0},x:e.x,y:e.y};return r}),u=d3.nest().key(function(n){return n.clusterId}).entries(i),o=u.map(function(n){var e=d3.sum(n.values,function(n){return n.y}),r=d3.min(n.values,function(n){return n.display.y0}),i={color:"blue",dx:t,dy:e,x:n.values[0].x,y0:r,y1:r+e,name:n.values[0].clusterId,sourceLink:[],targetLink:[],lineContentArr:n.values,lineContent:n.values.map(function(n){return n.lineContent}),clusterId:n.values[0].clusterId,value:e,numLine:n.values.length};return i});return o});i=i.sort(r);for(var u=[],o=[],a=0;a<i.length-1;a++){var c=computeLinkBetweenNodes(i[a],i[a+1],t);u=u.concat(c),o=o.concat(i[a])}return o=o.concat(i[i.length-1]),{nodeArr:o,linkArr:u}}function computeLinkBetweenNodes(n,t,e){function r(n,t){return d3.ascending(n.y0,t.y0)}function i(n,t,r){var i,u,o,a,c,s,l,d,f={defined:-1},y=findIntersection(n.lineContent,t.lineContent);if(0!=y.length){var v=n.lineContentArr.filter(function(n){return-1!=y.indexOf(n.lineContent)}),g=t.lineContentArr.filter(function(n){return-1!=y.indexOf(n.lineContent)});i=d3.sum(v,function(n){return n.y}),u=d3.sum(g,function(n){return n.y}),o=r.filter(function(t){return t.clusterId==n.clusterId&&t.x==n.x})[0].y0,c=r.filter(function(n){return n.clusterId==t.clusterId&&n.x==t.x})[0].y0,a=o+i,s=c+u,l=n.x,d=t.x,r.forEach(function(e){e.clusterId==n.clusterId&&e.x==n.x?e.y0=a:e.clusterId==t.clusterId&&e.x==t.x&&(e.y0=s)}),f={defined:1,dy0:i,dy1:u,links:[{source:{x:l,y:o,nodeTrans:e/2},target:{x:d,y:c,nodeTrans:-e/2}},{source:{x:l,y:a,nodeTrans:e/2},target:{x:d,y:s,nodeTrans:-e/2}}],drag:{x:0,y:0},intersect:y,source:n,target:t}}return{clusterLink:f,nodeBaseLine:r}}t=t.sort(r),n=n.sort(r);var u=[],o=n.concat(t).map(function(n){return{clusterId:n.clusterId,y0:n.y0,x:n.x}});return n.forEach(function(n){t.forEach(function(t){var e=i(n,t,o),r=e.clusterLink;o=e.nodeBaseLine,1==r.defined&&(u.push(r),n.sourceLink.push(r),t.targetLink.push(r))})}),u}function findNail(n,t,e){if(0!=n.curDrag){{var r=(n.toIndex,t[0]-n.m_nail.left-20),i=-2,u=0,o=n.rectOffset_nail;n.height_nail+2*o.height+u}if(e){var r=t[0];t[1]}for(var a=n.nailDataArr,c=0;c<a.length;c++)r>=a[c].startPoint_nail-o.width&&r<=a[c].endPoint_nail+o.width?i=c:0==c&&r<a[c].startPoint_nail-o.width?i=-.1:c!=a.length-1&&r>a[c].endPoint_nail+o.width&&r<a[c+1].startPoint_nail-o.width?i=c+.1:c==a.length-1&&r>a[c].endPoint_nail+o.width&&(i=-1);n.toIndex=i}}var interpolate="monotone",shortContent={Agriculture:"AGR",Leisure_and_hospitality:"LH",Manufacturing:"MANU",Wholesale_and_Retail_Trade:"WRT",Information:"INFO",Business_services:"BS",Mining_and_Extraction:"ME","Self-employed":"SE",Other:"O",Finance:"CON",Transportation_and_Utilities:"CON",Government:"GOV",Education_and_Health:"EH",Construction:"CON"};