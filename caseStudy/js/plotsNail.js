function updateNailArr(a,t){var e=a.stackedDataArr[t].stackedData,r=e.map(function(a){return a.values}),n=[];e.forEach(function(a){-1==n.indexOf(a.lineContent)&&n.push(a.lineContent)}),r=d3.transpose(r);var l=r.map(function(a){return{x:parseInt(a[0].x),y:d3.sum(a,function(a){return a.y}),drag:{x:0,y:0}}}),i={key:t,values:l,drag:{x:0,y:0},lineContentArr:n};a.nailDataArr[t].nailData=i,a.nailDataArr[t].yScale_nail.domain([0,d3.max(l,function(a){return a.y})])}function plotNailStack(a,t,e){if(updateNailArr(a,e),0!=t){var r=a.rectOffset_nail,n=a.nailDataArr[e],l=(n.xScale_nail,n.areaProcess_nail),i=nailColor,c=a.nailSVG,d=c.selectAll(".nailStack"+e),o=a.stackProcess,s=n.nailData,u=d3.behavior.drag().on("drag",function(t){a.curDrag=!0,t.drag.x+=d3.event.dx,t.drag.y+=d3.event.dy,dragmoveNail(e,t.drag),findNail(a,[d3.event.x,d3.event.y],!0)}).on("dragend",function(t){a.curDrag=!1,t.drag.x&&(t.drag.x=0,t.drag.y=0,drawReorderedNail(a,t))});s=o([s]),c.selectAll(".nailStackRect"+e).empty()&&c.selectAll(".nailStackRect"+e).data(s).enter().append("rect").attr("class",function(){return"nail nailStackRect nailStackRect"+e+" nail"+e+" graph"+e}).attr("y",function(){return 0}).attr("x",function(){return n.startPoint_nail-r.width}).attr("height",function(){return a.height_nail+r.height}).attr("width",function(){return 100+2*r.width}).attr("fill",function(){return"#FFECE0"}).attr("opacity",function(){return.5}).attr("stroke",function(){return"#ADA379"}).attr("stroke-width",function(){return 1}).attr("stroke-dasharray",function(){return"3,3"}),d.empty()?c.selectAll(".nailStack"+e).data(s).enter().append("path").attr("class",function(){return"nail nailStack nailStack"+e+" nail"+e+" graph"+e}):d.data(s).transition().duration(1e3).attr("class",function(){return"nail nailStack nailStack"+e+" nail"+e+" graph"+e}),c.selectAll(".nailStack"+e).attr("d",function(a){return l(a.values)}).style("fill",i),c.selectAll(".nail"+e).on("mouseover",function(t){1==a.curDrag&&(a.toIndex=t.key),d3.select(this).classed("hover",!0)}).on("mouseout",function(){d3.select(this).classed("hover",!1)}).on("click",function(){a.selectedNail=a.selectedNail!=e?e:-1,updateNailSelect(a)}).call(u),d3.select("#nailStack").on("mousemove",function(){findNail(a,d3.mouse(this),!1)})}}function updateNailSelect(a){var t=a.selectedNail,e=nailColor;if(deleteRow(),-1==t)d3.selectAll(".nailStack").style("fill",e),d3.selectAll(".stackRect").style("fill","rgba(255,0,0,0)").attr("stroke-width",function(){return 0}).transition();else{addRow(a.nailDataArr[t].nailData.lineContentArr,a);var r=a.stackedDataArr[t];d3.selectAll(".nailStack").style("fill",e),d3.selectAll(".nailStack"+t).style("fill","#E7191B"),d3.selectAll(".stackRect").attr("y",function(){return r.endPoint-20}).style("fill","rgba(255,255,240,0.15)").attr("stroke-width",function(){return 1}).transition()}}function drawReorderedNail(a,t){var e=a.toIndex,r=t.key;if(Math.abs(e-t.key)<1)return a.stackedDataArr.forEach(function(t,e){plotPartialStack(a,!0,e)}),void updateNailSelect(a);if(-2!=e){if(e==Math.round(e)&&e>=0)a.stackedDataArr[e].stackedData=a.stackedDataArr[e].stackedData.concat(a.stackedDataArr[r].stackedData).sort(sortByCluster),a.stackedDataArr[r].stackedData=[],a.stackedDataArr[r].curTotalContri=computeTotalContribute(a.stackedDataArr[r].stackedData,a),a.stackedDataArr[e].curTotalContri=computeTotalContribute(a.stackedDataArr[e].stackedData,a);else{var n=r,l=Math.ceil(e);-1==l&&(l=a.stackedDataArr.length),(l-n>1||n-l>=1)&&orderStacked(a,l,n),e=l-1,n-l>=1&&(e=l)}a.selectedNail==r?a.selectedNail=e:a.selectedNail>r&&a.selectedNail<=e?a.selectedNail=a.selectedNail-1:a.selectedNail<r&&a.selectedNail>=e&&(a.selectedNail=a.selectedNail+1),proporgateStackedArr(a),deleteRow(),a.stackedDataArr.forEach(function(t,e){plotPartialStack(a,!0,e)}),updateNailSelect(a)}}function orderStacked(a,t,e){var r=a.stackedDataArr[e].stackedData,n=a.stackedDataArr[e].curTotalContri,l=a.nailDataArr[e].nailData,i=t,c=e;if(t!=e){if(t>e){i=e,c=t;for(var d=i;c-1>d;d++)a.stackedDataArr[d].stackedData=a.stackedDataArr[d+1].stackedData,a.stackedDataArr[d].curTotalContri=a.stackedDataArr[d+1].curTotalContri,a.nailDataArr[d].nailData=a.nailDataArr[d+1].nailData;a.stackedDataArr[t-1].stackedData=r,a.stackedDataArr[t-1].curTotalContri=n,a.nailDataArr[t-1].nailData=l}if(e>t){for(var d=c;d>i;d--)a.stackedDataArr[d].stackedData=a.stackedDataArr[d-1].stackedData,a.stackedDataArr[d].curTotalContri=a.stackedDataArr[d-1].curTotalContri,a.nailDataArr[d].nailData=a.nailDataArr[d-1].nailData;a.stackedDataArr[t].stackedData=r,a.stackedDataArr[t].curTotalContri=n,a.nailDataArr[t].nailData=l}}}function dragmoveNail(a,t){d3.selectAll(".nail"+a).classed("unselected",!1).attr("transform",function(){return"translate("+[t.x,t.y]+")"}),d3.event.sourceEvent.stopPropagation()}