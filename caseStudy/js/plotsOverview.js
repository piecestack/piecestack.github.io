function contributeScale(t,e,a,r){var n=d3.extent(t,function(t){return t[e]});1/0==r&&(r=(n[0]+n[1])/2);var l=Math.abs(n[0]-r);Math.abs(n[0]-r)<Math.abs(n[1]-r)&&(l=Math.abs(n[1]-r));var s=d3.scale.sqrt().domain([-l+r,r,l+r]).range(a);return s}function proporgateStackedArr(t){var e=t.stackedDataArr.map(function(t){return t.stackedData.length}),a=e.indexOf(0);if(-1!=a){for(var r=a;r<t.stackedDataArr.length-1;r++)t.stackedDataArr[r].stackedData=t.stackedDataArr[r+1].stackedData,t.stackedDataArr[r].curTotalContri=t.stackedDataArr[r+1].curTotalContri,t.nailDataArr[r].nailData=t.nailDataArr[r+1].nailData;t.selectedNail==t.stackedDataArr.length-1&&(t.selectedNail=t.stackedDataArr.length-2),d3.selectAll(".graph"+(t.stackedDataArr.length-1)).remove(),t.stackedDataArr.pop(),t.nailDataArr.pop()}}function genStackedArr(t,e){var a,r,n,l,s=computeTotalContribute(e,t),c=t.xTickFormat,i=t.width_perNail,o=t.rectOffset_nail,e=e.sort(sortByCluster),d=e.map(function(t){return t.values});d=d3.transpose(d);var u=d.map(function(t){return{x:parseInt(t[0].x),y:d3.sum(t,function(t){return t.y}),drag:{x:0,y:0}}}),p={key:t.stackedDataArr.length,values:u};if(0==t.stackedDataArr.length)a=0,r=t.height,l=0,n=i;else{var h=t.stackedDataArr.length-1;a=t.stackedDataArr[h].startPoint+t.padding,r=a+t.height,l=t.nailDataArr[h].endPoint_nail+t.padding_nail,n=l+i}d3.select("#partialStack").style("height",r+500+"px"),d3.selectAll(".overlay").attr("height",r);var g=d3.scale.linear().domain(d3.extent(u,function(t){return t.x})).range([l,n]),y=d3.scale.linear().domain([0,d3.max(u,function(t){return t.y})]).range([t.height_nail-o.height,o.height]),f=d3.scale.linear().domain(d3.extent(u,function(t){return t.x})).range([0,t.width]),A=d3.scale.linear().domain([t.range.minY,t.range.maxY]).range([r,a]),v=d3.svg.axis().scale(f).tickFormat(c).orient("bottom"),x=d3.svg.axis().scale(A).tickFormat(d3.format(",.2f")).orient("left"),k=d3.svg.axis().scale(g).tickFormat(c).orient("bottom"),m=d3.svg.axis().scale(y).tickFormat(d3.format(",.2f")).orient("left"),D=d3.svg.area().interpolate(interpolate).x(function(t){return g(t.x)}).y0(function(t){return y(t.display.y0)}).y1(function(t){return y(t.display.y+t.display.y0)}),S=d3.svg.area().interpolate(interpolate).x(function(t){return f(t.x)}).y0(function(t){return A(t.display.y0)}).y1(function(t){return A(t.display.y+t.display.y0)}),C={endPoint:a,startPoint:r,yScale:A,xScale:f,xAxis:v,yAxis:x,stackedData:e.sort(sortByCluster),areaProcess:S,curTotalContri:s},b={endPoint_nail:n,startPoint_nail:l,yScale_nail:y,xScale_nail:g,xAxis_nail:k,yAxis_nail:m,nailData:p,areaProcess_nail:D};t.stackedDataArr.push(C),t.nailDataArr.push(b)}function unSelect(){d3.selectAll(".hover").classed("hover",!1),d3.selectAll(".selected").classed("selected",!1),d3.selectAll(".unselected").classed("unselected",!1),d3.selectAll(".brushText").remove(),d3.selectAll(".sankeyLink").remove(),d3.selectAll(".clusterNode").remove()}function genClassName(t,e,a){var r=t+" "+t+a+" graph"+a,n=t+a;return e.forEach(function(e){var l="-"+e.key+"-"+e.value;n+=l,r+=" "+t+a+l}),r+=" "+n}function plotPartialStack(t,e,a){if(d3.selectAll(".hover").classed("hover",!1),d3.selectAll(".selected").classed("selected",!1),d3.selectAll(".unselected").classed("unselected",!1),d3.selectAll(".brushText").remove(),0!=e){d3.selectAll(".graph"+a).remove(),d3.select(".toolTip"+a).empty()&&d3.select("body").append("div").attr("class","tooltip toolTip"+a).style("opacity",0);{var r=d3.select(".toolTip"+a),n=t.stackedDataArr[a],l=n.xScale,s=n.areaProcess,c=t.color,i=t.svg,o=i.selectAll(".partialStack"+a),d=t.stackProcess,u=t.totalXRange,p=n.stackedData,h=!1,g=n.startPoint;t.nailDataArr[a].nailData}d3.select("#partialStack").style("height",g+500+"px"),i.selectAll(".stackRect").empty()&&i.selectAll(".stackRect").data(p).enter().append("rect").attr("class",function(){return"stackRect"}).attr("y",function(){return-20}).attr("x",function(){return-t.m.left/2}).attr("height",function(){return t.height+50}).attr("width",function(){return t.width+t.m.left/2+t.m.right-10}).attr("fill",function(){return"rgba(255,255,240,0)"}).attr("opacity",function(){return.3}).attr("stroke",function(){return"#ADA379"}).attr("stroke-width",function(){return 0}).attr("stroke-dasharray",function(){return"3,3"});var y=d3.behavior.drag().on("drag",function(e){if(t.curDrag=!0,d3.selectAll(".hoverSeqOutline").remove(),e.drag.x+=d3.event.dx,e.drag.y+=d3.event.dy,h){var r=p.filter(function(t){return e.clusterId==t.clusterId});d3.selectAll(".contriGlyph-cluster-"+e.clusterId).remove(),r.forEach(function(t){dragmove(t.lineContent,a,e.drag)})}else dragmove(e.lineContent,a,e.drag)}).on("dragend",function(e){if(t.curDrag=!1,e.drag.y&&t.toIndex>-2)e.drag.x=0,e.drag.y=0,h?decompositionFunc(e,"cluster",t,a):decompositionFunc(e,"sequence",t,a),h=!1;else if(e.drag.y){e.drag.x=0,e.drag.y=0;for(var r=a;r<t.stackedDataArr.length;r++)plotPartialStack(t,!0,r)}t.toIndex=-2});d3.selectAll(".yAxis"+a).empty()&&i.append("g").attr("class","y axis yAxis yAxis"+a+" graph"+a).call(n.yAxis).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").text("Aggregation"),d3.selectAll(".xAxis"+a).empty()&&i.append("g").attr("class","x axis xAxis xAxis"+a+" graph"+a).attr("transform","translate(0,"+n.startPoint+")").call(n.xAxis),p=d(p),o.empty()?i.selectAll(".partialStack"+a).data(p).enter().append("path").attr("class",function(t){[{key:"sequence",value:t.lineContent.slice(1)},{key:"cluster",value:t.clusterId}];return"partialStack partialStack"+a+" stack-"+a+"-sequence-"+t.lineContent.slice(1)+" stack-"+a+"-cluster-"+t.clusterId+" sequence-"+t.lineContent.slice(1)+" cluster-"+t.clusterId+" graph"+a}):o.data(p).attr("class",function(t){return"partialStack partialStack"+a+" stack-"+a+"-sequence-"+t.lineContent.slice(1)+" stack-"+a+"-cluster-"+t.clusterId+" sequence-"+t.lineContent.slice(1)+" cluster-"+t.clusterId+" graph"+a}),i.selectAll(".partialStack"+a).attr("d",function(t){return s(t.values)}).style("fill",function(t){return c(t)}).on("mouseover",function(e){hoverFunc(e,t,a),d3.selectAll(".stack-"+a+"-sequence-"+e.lineContent.slice(1)).classed("hover",!0),r.transition().duration(200).style("opacity",toolTipOp),r.html(e.lineContent).style("left",d3.event.pageX+5+"px").style("top",d3.event.pageY+10+"px").style("text-align","center").style("font-weight",600)}).on("mouseout",function(t){d3.selectAll(".hoverSeqOutline").remove(),d3.selectAll(".stack-"+a+"-sequence-"+t.lineContent.slice(1)).classed("hover",!1),r.transition().duration(500).style("opacity",0)}).on("mousedown",function(){d3.event.shiftKey&&(h=!0)}).on("click",function(e){d3.selectAll(".hoverSeqOutline").remove(),d3.selectAll(".hover").classed("hover",!1),d3.selectAll(".brushText").classed("hover",!1),deleteRow(),d3.event.shiftKey?brushResponseFunc(e,"cluster",t,a):brushResponseFunc(e,"sequence",t,a)}).call(y),d3.selectAll(".brushNoticeLine"+a).empty()&&i.append("line").attr("class","brushNoticeLine brushNoticeLine"+a+" graph"+a).attr("y1",n.endPoint-6).attr("y2",n.startPoint+6).attr("x1",l(u[0])).attr("x2",l(u[0])),plotNailStack(t,e,a),drawAggregation(t,a),i.selectAll("*").on("mousemove",function(){var e=d3.mouse(this)[0];brushNoticeLine(e,t)}),plotGlyphContri(t,glyphThreshold,a)}}var interpolate="monotone",interactDuration=200,glyphThreshold=.3,toolTipOp=.95,tension=.8,nmiThreshold=.01,curHideGlyph=d3.selectAll(".glyphHide"),nailColor="#e7969c",greenColor="#00cc00",grayColor="#cccccc",redColor="#e30000";